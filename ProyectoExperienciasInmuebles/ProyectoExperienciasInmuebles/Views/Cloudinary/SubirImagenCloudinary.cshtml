@{
    ViewBag.Title = "Subir Imagen a Cloudinary";
    Layout = null;
}

<div>
    @Html.Partial("_HeaderNav")
</div>

<link rel="stylesheet" href="~/Content/css/MantCliente.css" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<br />
<h2 class="text-center">SUBIR IMAGEN A CLOUDINARY</h2>

@using (Html.BeginForm("SubirImagenCloudinary", "Cloudinary", FormMethod.Post, new { enctype = "multipart/form-data", id = "form-subir" }))
{
    <div class="form-horizontal">
        <h4 class="text-center">Selecciona y sube la imagen</h4>
        <hr />
        <br />

        <div class="form-group">
            <div class="form-row">
                <div class="col-md-6">
                    <label class="control-label" for="archivo">Seleccionar archivo:</label>
                    <input type="file" class="form-control bg-dark text-light" name="archivo" id="archivo" required />
                </div>
            </div>

            <div class="form-row mt-4">
                <div class="col-md-12 text-center">
                    <button type="submit" class="btn btn-success">Subir Imagen</button>
                </div>
            </div>
        </div>
    </div>
}

@if (ViewBag.Mensaje != null)
{
    <div class="text-center mt-4 alert alert-info">
        @ViewBag.Mensaje
    </div>
}

@if (ViewBag.UrlImagen != null)
{
    <div class="form-horizontal mt-5">
        <h4 class="text-center">Resultado de la Subida</h4>
        <hr />
        <br />

        <div class="form-group">
            <div class="form-row text-center">
                <div class="col-md-12">
                    <label class="control-label">Imagen subida:</label><br />
                    <img src="@ViewBag.UrlImagen" class="img-thumbnail mb-3" style="max-width: 300px;" />
                </div>
            </div>

            <div class="form-row">
                <div class="col-md-12">
                    <label class="control-label">URL de la imagen:</label>
                    <div class="input-group">
                        <input type="text" id="urlImagenInput" class="form-control" value="@ViewBag.UrlImagen" readonly style="overflow-x: auto;" />
                        <button id="btnCopiar" class="btn btn-outline-secondary" type="button" title="Copiar URL">
                            📋
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<div class="button-group-container text-center mt-4">
    <button type="button" class="btn btn-danger btn-lg px-5 py-3 fw-bold" onclick="cerrarPestana()">CERRAR</button>
</div>

<script>
    function cerrarPestana() {
        window.open('', '_self', '');
        window.close();
    }
</script>

<script>
    document.getElementById("form-subir").addEventListener("submit", function (e) {
        const archivoInput = document.getElementById("archivo");
        const nombreArchivo = archivoInput.files[0]?.name;

        if (sessionStorage.getItem(nombreArchivo)) {
            e.preventDefault();
            Swal.fire({
                title: 'Archivo repetido',
                text: 'Ya subiste un archivo con el mismo nombre. ¿Deseas continuar?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, subir de nuevo',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    sessionStorage.setItem(nombreArchivo, true);
                    document.getElementById("form-subir").submit();
                }
            });
        } else {
            sessionStorage.setItem(nombreArchivo, true);
        }
    });
</script>

<script>
    window.addEventListener("DOMContentLoaded", function () {
        const btnCopiar = document.getElementById("btnCopiar");
        const input = document.getElementById("urlImagenInput");

        // Quitar el foco automático por seguridad
        document.activeElement?.blur();

        if (btnCopiar && input) {
            btnCopiar.addEventListener("pointerdown", function (e) {
                e.preventDefault();
                input.select();
                input.setSelectionRange(0, 99999);
                document.execCommand("copy");

                Swal.fire({
                    position: 'center',
                    icon: 'success',
                    title: 'URL copiada al portapapeles',
                    showConfirmButton: false,
                    timer: 1500
                });
            });
        }
    });
</script>
